# 浅谈灰度发布

## 前言

最近工作室的整个从开发到用户的流程又要迎来一波升级，可能准备引入灰度发布、可视化埋点等新的功能，于是在这里我准备先好好了解下灰度的概念。

先来确定一下本文要探讨的问题：

- 灰度发布的概念？
- 灰度发布的优劣势？
- 如何实现灰度发布？

## 灰度测试的必要性

数月前微信就曾进行过一次灰度测试，具体灰度了啥我忘记了，但好像还蛮重要的一个功能，因为在回滚之后引来了不少要求全线使用的呼声。这就是一次完整的灰度发布流程，挑选一部分用户提前体验某个/批功能，然后视收集回来的数据和反馈决定下一步怎么做，扩大范围还是回滚老版本？

对于广大用户来说，我们开开心心整出来的产品他们并不一定会都买账，因此灰度测试就显得很有必要，在灰度期内我们仍然可以继续根据用户反馈修改功能。借助于灰度发布，我们得以实现了以下功能：

- 提前获得小批次反馈，即使出现重大问题也不要紧，还可以紧急修复或者直接回滚上一个版本。如果小批次反馈反响不错就可以考虑继续完善后进行更大范围的灰度测试。
- 验证产品的思路是否迎合大部分用户口味，毕竟千人千面，某个新功能可能甲之蜜糖乙之砒霜。



## 实现灰度发布

灰度发布的流程大致是这样：

- 完成新功能
- 选定筛选策略
- 进行筛选用户
- 接入转发系统
- 得到反馈，进行总结
- 考虑是加大范围还是回滚版本



这里我对选定策略和转发比较感兴趣，因此就只讲述一下这两个地方的实现思路。



### 选定策略

- 覆盖程度，决定选多少人，从1%->5%...这种？
- 如何回滚？这个应该和选择的发布渠道有很大关系，如果是APP自升级，登陆后在转发中台做URL转发等就简单一些，也比较无痛？
- 运营策略，比如要不要提醒用户嗨我们偷偷给你开了小灶你赶紧去瞅瞅合不合宁的口味吧~
- 面向某种用户？还是面向所有用户？对用户的筛选可能也有专门的策略，如活跃程度、单日在线、用户特征等。对于工作室情况，我觉得可能就是工作人员和小范围邀请测试吧。



### 转发

先说突然想到的一个问题，进行灰度意味着有一批用户的数据里可能会出现当前数据库里没有的字段，就意味着需要新的数据库配合，后端接口也需要跟上。如果用户请求走到了新系统数据库，那么意味着需要再做一层转发给旧数据库（用户可能同时在使用新、旧功能），然后新数据库里只做新功能的数据保留。emmm感觉需要根据具体场景吧，如果只是添加个模块，那么只要在后端新增一个专门的接口把数据打到新数据库就行（接口能做的这么细粒度吗），然后事务以老系统成功为准。如果是完全的新系统，并且新数据库中已经有了所有新系统字段这种情况，那么就需要前面那种方法了，老数据库被选中的用户数据会被拷贝到新数据库进行测试。

（以上仅为个人猜想）

然后如果是WEB端就简单一些了，以新云家园为例，登陆后如果id是被选中的幸运儿，就重定向到新的网址/资源，应该是新的资源吧，这样我们只要用版本号区分开两种资源的CDN就好了。

但是如果是SSR应用又有所不同了，在这种情况下服务端还需要根据名单渲染新的页面然后返回，诶我很好奇灰度遇到SEO会擦出怎样的火花？假定机器人非常智能完全能模拟用户。



当然实际上应该没有这么简单，还是需要Nginx等方式配合才能完成流程，这里只是先做一个初步的了解。网上看到的不少方案这里就先不贴出来了，等后续商讨加深理解后再进行总结梳理。