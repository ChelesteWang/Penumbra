# 首屏优化方案探讨

> 用户永远不会嫌网页打开的太快。
>
> 首屏加载时间对用户的留存率影响很大，参考一些大厂的APP/网页，不论页面有多复杂，组件是如何层层叠叠，完成首屏加载的时间都是很短的。
>
> webpack性能优化，资源懒加载，cdn/浏览器缓存...，似乎每种方案都见过，但是见了又忘咯。于是今天特意整理一哈。有部分措施我觉得没有展开写的必要就只留了个简介。

## 浏览器端

### 使用webpack进行打包资源优化

**webpack**用的好，代码烦恼多不了~ 以下会尽可能详细的列举出在配置过程中每一处可能影响打包时间的地方。

- 优化构建速度
  - 配置 `resolve` 字段，来减少webpack搜索待打包文件的时间。包括 `mainFields` `extension` 等，类似的还有 `exclude` / `include` 等
  - 多进程压缩，如使用 `ParallelUglifyPlugin` 来多进程压缩JS文件（可以在子进程调用`UglifyJS`~）
  - `externals`字段，排除掉会在页面内独立引入的代码
- 优化资源大小
  - 压缩各类文件时对应的插件配置，去除无用的代码/注释等，如 `purify-CSS-plugin` 与 `tree-shaking`（注意，摇树优化需要在 `.babelrc` 文件中关闭转化为`commonJS`规范(`module: false`)）
  - 压缩图片及将小于某个大小的图片Base64转码
  - 代码分割（code spliting）按需加载，例如将不同功能的代码合并成不同的chunk，在首屏入口只加载少量代码。按需加载如 `Lodash` 这种工具类库还是很有必要的，可以看[这篇文章](https://imys.net/20161217/webpack-use-lodash.html)
  - 突然想到如果首屏是鉴权页，可以分离出来单独做一个SPA
  - 懒加载如 `const Lazy = () => import('@/components/lazy');`
  - 预加载，prefetch与preload，前者的权重低，浏览器会在空闲时间才去加载，后者权重高~，可以配合代码分割提前去加载代码。
  - 启用Gzip压缩
  - 关闭 source-map 或者调整模式，如`devtool:"cheap-source-map"`
  - 对于MPA应用，可以提取公共的文件
  - 使用一些打包分析插件，继续优化，精确到某个包来针对性优化。剔除语言包啊啥的。
- 代码相关优化
  - 将样式文件放在`<Head>` 标签中
  - async 与 defer
  - 避免 @import /通配符/ !important
  - 动画，使用 `transform` 开启图形加速，用 `translate` 代替 `left`等
  - React，优化主要针对于 闭包、无用的重渲染、函数式组件等

 ### SSR方案

- 使用如 `Next.js` / `Nuxt.js` 的方案
- 但是并不是首屏加载慢就直接上SSR的...，毕竟服务器计算资源也不便宜，还是先考虑下CSR下的优化方案。除非是SEO和用户体验真的影响很大

### 请求优化

- 节流，防抖，考虑请求并行数量

- CDN分发

- 前端的缓存，如 `localStorage` 和 `manifest`

- 浏览器缓存，如 `filename: "[name].[contenthash:8].js"`

- 后端的缓存，比如在数据库上面做一层缓存

  总结一下缓存，根据更新方式可以分成两种，一种是根据 `If-Modified-Since / ETag` ，向后端问询是否有更新，没有就返回304，浏览器使用本地缓存。另一种是根据 `协议里的 Cache-Control / Expires` 去确定，多长时间以内不用去问询更新而是直接使用本地缓存。

- http缓存，文件hash+强缓存

- 使用更先进的图片格式如 `JPEG 2000`, `JPEG XR`, `WebP `的图片格式来代替现有的jpeg和png

- 启用http2.0，请求和响应的多路复用、头部压缩

- nginx gzip压缩

## 移动端

> 一个常见的点击打开新页面的流程至少要发起四个请求，html、css、js以及页面数据，虽然现在移动设备的性能不断增强，内嵌h5界面的性能正在越来越好，但是还是会有白屏以及响应流畅度问题。

**一个简单的打开新页面到页面展示之间的过程**

初始化 webview -> 请求页面 -> 下载数据 -> 解析HTML -> 请求 js/css 资源 -> dom 渲染 -> 解析 JS 执行 -> JS 请求数据 -> 解析渲染 -> 下载渲染图片

**大部分能进行的工作在上面已经提过，这里只贴一个我觉得很好的方案，[原文链接](https://segmentfault.com/a/1190000019584038)**

![better](https://segmentfault.com/img/bVbukRf?w=1756&h=1318)

- 前端开发完毕，上线打包时会产出两个html文件，一个用于正常上线，另外一个作为预加载，以字符串形式写入后台配置服务，静态资源上传cdn。
- 用户访问客户端，后台会“偷偷的”把预加载要用的html字符串、静态文件塞下来，客户端把它保存起来并且下载静态文件保存。注意，这里客户端需要进行版本校验、资源完整性校验，然后才会决定是否使用。
- 用户访问页面，客户端会去加载本地的html模板字符串，拦截webview的静态资源请求，使用之前下载好的文件。